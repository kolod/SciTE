<html><head>
<meta http-equiv=Content-Type Content="text-html; charset=windows-1251">
<meta http-equiv=MSThemeCompatible Content=Yes>
<hta:application
id=SWI
applicationName=SciTE_Windows_Integrator
icon=regedit.exe
maximizeButton=no
innerBorder=no
border=thin
scroll=no
selection=no
contextMenu=no
singleinstance=yes
version=2.3
>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<style type="text/css">
	body, table, td, input, button {
		font:normal normal 8px MS Sans Serif;
		white-space:nowrap;
		margin:0;
	}

	body, table {
		background-color:threedface;
	}

	button {width:95px;}

	fieldset{
		cursor:default;
		margin:0px;
		text-align:left;
		padding:4px;
		padding-top:0px;
	}

	legend {
		margin-bottom:2px;
		color:blue;
	}

	label {
		cursor:hand;
		white-space:nowrap;
	}

	a.help {text-decoration:none}

	a.help:hover {
		position:relative;
		cursor:help;
	}

	a.help span.help {
		display:none;
	}

	a.help:hover span.help {
		margin:2;
		color:black;
		display:block;
		position:absolute;
		top:20px;
		left:20px;
		background-color:white;
		border:1px solid #999999;
		padding:5px;
		cursor:help;
	}

	em {
		color:#CC3300;
		text-decoration:underline;
		font-style:normal;
	}

	cite {
		color:#0033CC;
		font-style:normal;
	}
</style>

<script language="JavaScript">
var WshShell = new ActiveXObject("WScript.Shell");
var ForReading = 1, ForWriting = 2, ForAppending = 8;
var fso = new ActiveXObject("Scripting.FileSystemObject");
var script_path = unescape(self.location.href).replace(/file:\/\/\/([a-z]:.*)\/.*?$/i,'$1').replace(/\//g,'\\');
var reg_backup = 'HKLM\\SOFTWARE\\SciTE\\Script\\WinIntegrator\\';

// Проверка локализации
var is_locale = false

// Проверка регистрации
function Check(){
	if (scite_path == ""){
		alert(as_locale(
			"Can't find SciTE!\nPlease run this script from folder with SciTE.",
			"SciTE не найден!\nЗапустите скрипт из каталога с установленным SciTE"));
		self.close();
	} else {
		CheckHome()
		CheckAssociations()
		CheckOpenfor()
		CheckSession()
		CheckHTML_def()
		CheckHTML()
		CheckHelper()
	}
}

// После нажатия на "ОК" проверяем, изменил ли пользователь установки
// и выполняем только те позиции, в которых состояние чекбоксов изменилось
function Set(){
	var _alert = false;
	for (i=0;i<form.chk.length;i++){
		if (form.chk[i].checked.toString() != form.chk[i].value.toString()){
			_alert = true;
			if (form.chk[i].checked){
				SetValue(form.chk[i].id);
			}else{
				UnSetValue(form.chk[i].id);
			}
		}
	}
	if (_alert){
		alert(as_locale("Integration completed successfully!", "Изменения успешно внесены в реестр!"));
	}
	self.close();
}

// Установка регистрации
function SetValue(id){
	switch(id){
	case "chk_home":
		SetHome();
		break;
	case "chk_associations":
		SetAssociations();
		break;
	case "chk_openfor":
		SetOpenfor();
		break;
	case "chk_ses":
		SetSessions();
		break;
	case "chk_html_def":
		SetHTML_def();
		break;
	case "chk_html":
		SetHTML();
		break;
	case "chk_helper":
		SetHelper();
		break;
	}
}

// Снятие регистрации
function UnSetValue(id){
	switch(id){
	case "chk_home":
		UnSetHome();
		break;
	case "chk_associations":
		UnSetAssociations();
		break;
	case "chk_openfor":
		UnSetOpenfor();
		break;
	case "chk_ses":
		UnSetSessions();
		break;
	case "chk_html_def":
		UnSetHTML_def();
		break;
	case "chk_html":
		UnSetHTML();
		break;
	case "chk_helper":
		UnSetHelper();
		break;
	}
}

// home ====================================================
function CheckHome(){
	form.chk_home.checked = false;
	form.chk_home.value = false;
	form.home.value = scite_path;
	form.home.disabled = true;
	try {
		var home = WshShell.RegRead('HKCU\\Environment\\SCITE_HOME');
		form.chk_home.checked = true;
		form.chk_home.value = true;
		form.home.value = home;
		form.home.disabled = false;
	} catch(e) {}
}

function SetHome(){
	WshShell.RegWrite('HKCU\\Environment\\SCITE_HOME', form.home.value);
}

function UnSetHome(){
	try {WshShell.RegDelete('HKCU\\Environment\\SCITE_HOME')}catch(e){};
}

// associations ============================================
function CheckAssociations(){
	form.chk_associations.checked = false;
	form.chk_associations.value = false;
	form.associations.value = "txt;php;h;cxx";
	form.associations.disabled = true;
	try {
		var _associations = WshShell.RegRead(reg_backup+'associations');
		form.chk_associations.checked = true;
		form.chk_associations.value = true;
		form.associations.value = _associations;
		form.associations.disabled = false;
	} catch(e) {}
}

function SetAssociations(){
	var Arr_associations = form.associations.value.split(';');
	for (var i=0;i<Arr_associations.length;i++){
		var ext = Arr_associations[i];
		if (ext != ''){
			var current_association = "";
			try {current_association = WshShell.RegRead('HKCR\\.'+ext+'\\')} catch(e) {}
			WshShell.RegWrite(reg_backup+ext, current_association);
			WshShell.RegWrite('HKCR\\.'+ext+'\\', 'SciTE.File');
		}
	}
	WshShell.RegWrite(reg_backup+'associations', form.associations.value);
	WshShell.RegWrite('HKCR\\SciTE.File\\', 'SciTE file');
	WshShell.RegWrite('HKCR\\SciTE.File\\DefaultIcon\\', form.home.value + '\\SciTE.exe,1');
	WshShell.RegWrite('HKCR\\SciTE.File\\shell\\open\\command\\', '"' + form.home.value + '\\SciTE.exe" "%1"');
}

function UnSetAssociations(){
	var Arr_associations = WshShell.RegRead(reg_backup+'associations').split(';');
	for (var i=0;i<Arr_associations.length;i++){
		var ext = Arr_associations[i];
		if (ext != ''){
			var old_association = "";
			try {
				old_association = WshShell.RegRead(reg_backup+ext);
				WshShell.RegDelete(reg_backup+ext);
			} catch(e) {}
			WshShell.RegWrite('HKCR\\.'+ext+'\\', old_association);
		}
	}
	WshShell.RegDelete(reg_backup+'associations');
}

// openfor =================================================
function CheckOpenfor(){
	form.chk_openfor.checked = false;
	form.chk_openfor.value = false;
	try {
		var _openfor = WshShell.RegRead('HKCR\\*\\shell\\Open with SciTE\\');
		form.chk_openfor.checked = true;
		form.chk_openfor.value = true;
	} catch(e) {}
}

function SetOpenfor(){
		WshShell.RegWrite('HKCR\\*\\shell\\Open with SciTE\\', 'Open with &SciTE');
		WshShell.RegWrite('HKCR\\*\\shell\\Open with SciTE\\command\\', '"' + form.home.value + '\\SciTE.exe" -check.if.already.open=0 "%1"');
}

function UnSetOpenfor(){
	try {
		WshShell.RegDelete('HKCR\\*\\shell\\Open with SciTE\\command\\');
		WshShell.RegDelete('HKCR\\*\\shell\\Open with SciTE\\');
	}catch(e){}
}

// session =================================================
var open_ses_file = 'open_session.js';

function CheckSession(){
	form.chk_ses.checked = false;
	form.chk_ses.value = false;
	try {
		var _ses = WshShell.RegRead('HKCR\\.session\\');
		if (fso.FileExists(script_path + '\\' + open_ses_file)){
			form.chk_ses.checked = true;
			form.chk_ses.value = true;
		}
	} catch(e) {}
}

function SetSessions(){
	WshShell.RegWrite('HKCR\\.session\\', 'SciTE.Session');
	WshShell.RegWrite('HKCR\\SciTE.Session\\', 'SciTE session file');
	WshShell.RegWrite('HKCR\\SciTE.Session\\DefaultIcon\\', form.home.value + '\\SciTE.exe,2');
	WshShell.RegWrite('HKCR\\SciTE.Session\\shell\\open\\command\\', 'wscript "' + script_path + '\\' + open_ses_file + '" "%1"');
	var text = 'var scite = "' + form.home.value.replace(/\\/g,'\\\\') + '\\\\SciTE.exe";\n';
	text += 'var WshShell = new ActiveXObject("WScript.Shell");\n';
	text += 'var filename = WScript.Arguments(0);\n';
	text += 'var opt = \'\"-loadsession:\' + filename.replace(\/\\\\\/g,\"\\\\\\\\\") + \'\"\';\n'
	text += 'var cmd = \'\"\' + scite + \'\" \' + opt;\nWshShell.Run(cmd, 0, false);\n\n';
	var file = fso.OpenTextFile(script_path + '\\' + open_ses_file, 2, true);
	file.Write(text);
	file.Close();
}

function UnSetSessions(){
	try{WshShell.RegDelete('HKCR\\.session\\')}catch(e){};
}

// html_def ================================================
function CheckHTML_def(){
	form.chk_html_def.checked = false;
	form.chk_html_def.value = false;
	try {
		var _html_def = WshShell.RegRead('HKLM\\SOFTWARE\\Microsoft\\Internet Explorer\\View Source Editor\\Editor Name\\');
		if (/scite/i.test(_html_def)){
			form.chk_html_def.checked = true;
			form.chk_html_def.value = true;
		}
	} catch(e) {}
}

function SetHTML_def(){
	var current_htmldef = "";
	try {var current_htmldef = WshShell.RegRead('HKLM\\SOFTWARE\\Microsoft\\Internet Explorer\\View Source Editor\\Editor Name\\')} catch(e) {}
	WshShell.RegWrite(reg_backup+'Source Editor', current_htmldef);
	WshShell.RegWrite('HKLM\\SOFTWARE\\Microsoft\\Internet Explorer\\View Source Editor\\Editor Name\\', '"' + form.home.value + '\\SciTE.exe"');
}

function UnSetHTML_def(){
	var old_htmldef = "";
	try {
		var old_htmldef = WshShell.RegRead(reg_backup+'Source Editor');
		WshShell.RegDelete(reg_backup+'Source Editor');
	} catch(e) {}
	WshShell.RegWrite('HKLM\\SOFTWARE\\Microsoft\\Internet Explorer\\View Source Editor\\Editor Name\\', old_htmldef);
}

// html ====================================================
function CheckHTML(){
	form.chk_html.checked = false;
	form.chk_html.value = false;
	try {
		var _html = WshShell.RegRead('HKCR\\.htm\\OpenWithList\\SCITE.EXE\\');
		form.chk_html.checked = true;
		form.chk_html.value = true;
	} catch(e) {}
}

function SetHTML(){
	WshShell.RegWrite('HKCR\\.htm\\OpenWithList\\SCITE.EXE\\', '');
	WshShell.RegWrite('HKCR\\Applications\\SCITE.EXE\\shell\\edit\\command\\', form.home.value + '\\SciTE.exe "%1"');
	try {WshShell.RegDelete('HKCU\\Software\\Microsoft\\Internet Explorer\\Default HTML Editor\\shell\\edit\\ddeexec\\')} catch(e) {};
	WshShell.RegWrite('HKCU\\Software\\Microsoft\\Internet Explorer\\Default HTML Editor\\shell\\edit\\command\\', form.home.value + '\\SciTE.exe "%1"');
	WshShell.RegWrite('HKCU\\Software\\Microsoft\\Internet Explorer\\Default HTML Editor\\Description', 'SciTE - a Scintilla based Text Editor');
	WshShell.RegWrite('HKCU\\Software\\Microsoft\\Shared\\HTML\\Default Editor\\shell\\edit\\command\\', form.home.value + '\\SciTE.exe "%1"');
}

function UnSetHTML(){
	try{WshShell.RegDelete('HKCR\\.htm\\OpenWithList\\SCITE.EXE\\')}catch(e){};
}

// helper ==================================================
function CheckHelper(){
	form.chk_helper.checked = false;
	form.chk_helper.value = false;
	try {
		var _helper = new ActiveXObject("SciTE.Helper");
		form.chk_helper.checked = true;
		form.chk_helper.value = true;
	} catch(e) {}
}

function SetHelper(){
	var file_dll = form.home.value + '\\tools\\Helper\\SciTE.dll';
	if (fso.FileExists(file_dll)){
	var ret = WshShell.Run('cmd /c for /f %i in ("msvbvm50.dll") do if "%~$PATH:i"=="" exit /b 1', 0, true);
		if (ret != 0) {
			msvbvm50();
		} else {
			WshShell.Run('Regsvr32 "' + file_dll + '"',0,false);
		}
	}
}

function UnSetHelper(){
	var file_dll = form.home.value + '\\tools\\Helper\\SciTE.dll';
	if (fso.FileExists(file_dll)){
		WshShell.Run('Regsvr32 /u "' + file_dll + '"',0,false);
	}
}

// =============================================================
// Окно "О программе"
function About() {
	if(top.location=='about:blank') {alert(as_locale('Can\'t working on blank page!', 'На пустой странице не работаю!'))}
	else{
		atr='status:no; help:no; dialogWidth:250px; dialogHeight:150px;';
		try {dW=PrxRealModelessDialog('dialog.htm',window,atr).document}
		catch(e) {dW=showModelessDialog('dialog.htm',window,atr).document}
		// -----------------------------------------------------------------------------------
		str1 = '<HTML><HEAD>\n';
		str1 += '<title>' + as_locale('About...', 'О программе') + '</title>\n';
		str1 += '<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">\n';
		str1 += '</HEAD><style>body {font-family:verdana; font-size:x-small; background-color:black; color:white} a{color:white; text-decoration:none;} a:hover{color:#99FFFF;}</style>\n';
		str1 += '<center><span style="width:240; height:30; font:40px Impact; color:#0EDA05; font-weight:bold; filter:Shadow (Color=#6699CC, Direction=135")>SciTE<\/span>\n';
		str1 += '<br><span style="position: absolute; margin-top:-28px; margin-left:-85px; font-family:Arial; font-size:20px; font-style:italic; font-weight:bold; color:#E5E1B1; filter:Shadow (Color=#84602C, Direction=135")">Windows Integrator<\/span><br><font color=white>Version <b>'+SWI.version+'</b><br>Copyleft by <b><a href="mailto:mozers@mail.ru?subject=SciTE_Windows_Integrator_'+SWI.version+'" title="Жду предложений и пожеланий :)">mozers&trade;</a></b></font></center>\n';
		str1 += '</BODY></HTML>';
		// -----------------------------------------------------------------------------------
		dW.write(str1);
	}
}
// =============================================================
// Окно "msvbvm50.dll"
function msvbvm50() {
	var alert_win = window.open("about:blank",null, "height=80,width=450,status=no,toolbar=no,menubar=no,location=no");
	var html = '<HTML><HEAD>\n';
	html += '<title>SciTE.Helper Install Error</title>\n';
	html += '<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">\n';
	html += '</HEAD><style>body {font-family:verdana; font-size:10pt; a {color:#000080; text-decoration:none;} a:hover {color:red;}</style>\n';
	html += as_locale(
	'<center><font color=red>Can\'t register <b>SciTE.Helper</b></font> in your sistem,<br> because required library <a href="http://www.google.com/search?q=MSVBVM50.DLL" target="_blank"><b>MSVBVM50.DLL</b></a> is absent.<br><br>For more information <a href="http://code.google.com/p/scite-ru/issues/detail?id=62" target="_blank"><b>Issue 62</b></a></center>\n',
	'<center><b>SciTE.Helper</b> <font color=red>не был зарегистрирован</font> в Вашей системе,<br>поскольку для его работы необходим <a href="http://www.google.com/search?q=MSVBVM50.DLL" target="_blank"><b>MSVBVM50.DLL</b></a>.<br><br>Подробности изложены в <a href="http://code.google.com/p/scite-ru/issues/detail?id=62" target="_blank"><b>Issue 62</b></a></center>\n');
	html += '</BODY></HTML>';
	alert_win.document.write(html);
}

// locale ==================================================
function as_locale(en_str, ru_str) {
	if (is_locale)
		return ru_str
	else
		return en_str
}

function write_as_locale(en_str, ru_str) {
	document.write(as_locale(en_str, ru_str))
}

// check scite ==================================================
function check_scite(scite_path){
	if (fso.FileExists(scite_path + "\\SciTE.exe")){
		return true;
	}else{
		return false;
	}
}

function find_scite(){
	var scite_path = script_path;
	if (check_scite(scite_path)){
		return scite_path;
	}else{
		scite_path = scite_path.replace(/\\[^\\]+$/,'');
		if (check_scite(scite_path)){
			return scite_path;
		}else{
			return "";
		}
	}
}

var scite_path = find_scite();
if (scite_path != ""){
	// Проверка локализации
	is_locale = fso.FileExists(scite_path + '\\locale.properties')
}
</script>

</head><body>
<form id="form">
<table width=100%><tr><td>

<fieldset><legend>&nbsp;<script language="JavaScript">
write_as_locale("Environment variable", "Установка переменных окружения")
</script>:&nbsp;</legend><table width=100%>
	<tr>
		<td>
			<a class="help" href="#" hidefocus>
			<input name="chk" type="checkbox" id=chk_home hidefocus onClick="home.disabled=!chk_home.checked">
			<span class="help"><script language="JavaScript">
			write_as_locale("Setup location for properties files", "Задает местоположение файлов настроек")
			</script><br>
				<cite>SciTEGlobal.properties</cite>, <cite>SciTE.session</cite>, <cite>SciTE.recent</cite><br><br>
				<script language="JavaScript">
				write_as_locale(
				"<em>ATTENTION!</em> Using of this variable is set properties files location<br> for all instanses of <cite>SciTE</cite>. Use this option carefully.",
				"<em>ВНИМАНИЕ!</em> Если Вы установите это значение, то любой экземпляр<br><cite>SciTE</cite>, запущенный на этой машине, будет искать файлы настроек<br>не в своем каталоге, а по пути указанному в этой переменной.")
</script></span></a>
			<label for=chk_home>SCITE_HOME&nbsp;=</label>
		</td>
		<td style="width:100%">
			<input type=text id="home" value="" style="width:100%; font:normal normal 10pt Courier New;">
		</td>
	</tr>
</table></fieldset>
&nbsp;

<fieldset><legend>&nbsp;<script language="JavaScript">
write_as_locale("Integration with explorer", "Интеграция в Проводник")
</script>:&nbsp;</legend>
<table width=100%>
	<tr>
		<td colspan="2">
			&nbsp;<script language="JavaScript">
			write_as_locale("Associate SciTE with extensions", "Связать файлы заданных расширений с SciTE")
			</script>:
		</td>
	</tr>
	<tr>
		<td>
			<a class="help" href="#" hidefocus>
			<input name="chk" type="checkbox" id=chk_associations hidefocus onClick="associations.disabled=!chk_associations.checked">&nbsp;
			<span class="help"><script language="JavaScript">
			write_as_locale("You'll able to open in SciTE files with this extensions by double click.", "Позволяет открывать в SciTE файлы ассоциированных типов<br> с помощью двойного клика мыши")
</script></span></a>
		</td>
		<td style="width:100%">
			<input TYPE=text id="associations" style="width:100%; font:normal normal 10pt Courier New;">
		</td>
	</tr>
</table>
<table width=100%>
	<tr>
		<td>
			<a class="help" href="#" hidefocus>
			<input name="chk" type="checkbox" id=chk_openfor hidefocus>
			<span class="help"><script language="JavaScript">
			write_as_locale("You'll able to open in SciTE any file from context menu.", "Позволяет открыть любой выбранный файл в SciTE")
			</script></span></a>
			<label for=chk_openfor><script language="JavaScript">
			write_as_locale("Add to context menu for all files new command ", "Добавить в контекстное меню всех файлов пункт")
			</script> "Open with SciTE"</label>
		</td>
	</tr>
	<tr>
		<td>
			<a class="help" href="#" hidefocus>
			<input name="chk" type="checkbox" id=chk_ses hidefocus>
			<span class="help"><script language="JavaScript">
			write_as_locale("You'll able to open SciTE session files by double click.", "Позволяет открывать сохраненные ранее сессиии SciTE")
			</script></span></a>
			<label for=chk_ses><script language="JavaScript">
			write_as_locale("Associate files *.session as SciTE session files", "Открывать файлы *.session как файлы сессий SciTE")
			</script></label>
		</td>
	</tr>
</table>
</fieldset>
&nbsp;

<fieldset><legend>&nbsp;<script language="JavaScript">
write_as_locale("Integration with Internet Explorer", "Интеграция в Internet Explorer")
</script>:&nbsp;</legend><table width=100%>
	<tr>
		<td>
			<a class="help" href="#" hidefocus>
			<input name="chk" type="checkbox" id=chk_html_def hidefocus>
			<span class="help"><script language="JavaScript">
			write_as_locale("Command \"View source\" will open source file in SciTE.", "Выбор пункта меню Internet Explorer '<cite>Просмотр HTML кода</cite>'<br> откроет текущую страницу в SciTE")
			</script></span></a>
			<label for=chk_html_def><script language="JavaScript">
			write_as_locale("Set SciTE as default HTML editor", "Установить SciTE в качестве дефолтового HTML редактора")
			</script></label>
		</td>
	</tr>
	<tr>
		<td>
			<a class="help" href="#" hidefocus>
			<input name="chk" type="checkbox" id=chk_html hidefocus>
			<span class="help"><script language="JavaScript">
			write_as_locale("On Internet Explorer toolbar can be placed button \"Edit\".<br> This option add the command \"Edit with SciTE\" to menu on this button.", "На панели инструментов Internet Explorer можно установить кнопку '<cite>Правка</cite>'.<br> Данная опция добавит в меню этой кнопки пункт '<cite>Править в SciTE</cite>'")
			</script></span></a>
			<label for=chk_html><script language="JavaScript">
			write_as_locale("SciTE as one editor from button menu \"Edit\"", "SciTE в качестве одного из редакторов в меню кнопки \"Правка\"")
			</script></label>
		</td>
	</tr>
</table></fieldset>
&nbsp;

<fieldset><legend>&nbsp;<script language="JavaScript">
write_as_locale("Integration with Windows", "Интеграция в Windows")
</script>:&nbsp;</legend><table width=100%>
<tr>
	<td>
		<a class="help" href="#" hidefocus>
		<input name="chk" type="checkbox" id=chk_helper hidefocus>
		<span class="help"><script language="JavaScript">
		write_as_locale("<cite>SciTE.Helper</cite> is needed for external scripts for communicate with SciTE.", "C помощью <cite>SciTE.Helper</cite> внешние скрипты и программы<br> смогут управлять SciTE и получать из него данные")
		</script></span></a>
		<label for=chk_helper><script language="JavaScript">
		write_as_locale("Install SciTE.Helper (COM-server for communication with SciTE)", "Установить SciTE.Helper (COM-сервер для управления SciTE)")
		</script></label>
	</td>
</tr>
</table></fieldset>
&nbsp;

<table width=100%>
	<tr>
		<td align=center width=33%><button onClick="Set();"><script language="JavaScript">
		write_as_locale("OK", "ОК")
		</script></button></td>
		<td align=center width=33%><button onClick="self.close();"><script language="JavaScript">
		write_as_locale("Cancel", "Отмена")
		</script></button></td>
		<td align=center width=33%><button onClick="About();"><script language="JavaScript">
		write_as_locale("About...", "О программе")
		</script></button></td>
	</tr>
</table>

</td></tr>
</table>
</form>

<script language="JavaScript">
document.title = SWI.applicationName.replace(/_/g,' ') + ' ' + SWI.version;
window.resizeTo(450,400);

Check();
</script>

</body>
</html>
